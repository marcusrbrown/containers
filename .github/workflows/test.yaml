name: Automated Testing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  prepare:
    if: github.event_name != 'workflow_dispatch'
    name: Prepare
    outputs:
      changes: ${{ steps.filter.outputs.changes }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Filter changed files
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            changes:
              - '**/*.py'
              - '**/Dockerfile'
              - '**/*.yaml'
              - '**/*.yml'
              - 'pyproject.toml'
              - '!archived/**'
              - '!templates/**'

  detect-containers:
    name: Detect Changed Containers
    needs: prepare
    if: github.event_name == 'workflow_dispatch' || needs.prepare.outputs.changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      containers: ${{ steps.detect.outputs.containers }}
      has-containers: ${{ steps.detect.outputs.has-containers }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Detect containers to test
        id: detect
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # For manual runs, test all containers
            containers=$(find . -name "Dockerfile" -not -path "./archived/*" -not -path "./templates/*" -not -path "./.devcontainer/*" | xargs -I {} dirname {} | sort -u)
          else
            # For PR/push, only test changed containers
            base_ref="${{ github.event.pull_request.base.sha || github.event.before }}"
            containers=$(git diff --name-only "${base_ref}..HEAD" | grep "Dockerfile$" | grep -v -E "(archived/|templates/|\.devcontainer/)" | xargs -I {} dirname {} | sort -u)
          fi

          if [[ -n "$containers" ]]; then
            # Convert to JSON array format
            container_array=$(echo "$containers" | jq -R -s -c 'split("\n") | map(select(length > 0)) | map({path: ., name: (split("/") | join("-"))})')
            echo "containers=$container_array" >> $GITHUB_OUTPUT
            echo "has-containers=true" >> $GITHUB_OUTPUT
            echo "Found containers to test:"
            echo "$containers"
          else
            echo "containers=[]" >> $GITHUB_OUTPUT
            echo "has-containers=false" >> $GITHUB_OUTPUT
            echo "No containers to test"
          fi

  container-builds:
    name: Test Container Builds
    runs-on: ubuntu-latest
    needs: detect-containers
    if: needs.detect-containers.outputs.has-containers == 'true'
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJSON(needs.detect-containers.outputs.containers) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@18ce135bb5112fa8ce4ed6c17ab05699d7f3a5e0 # v3.11.0

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ${{ matrix.container.path }}
          file: ${{ matrix.container.path }}/Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: test/${{ matrix.container.name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test container functionality
        run: |
          # Basic container inspection
          docker image inspect test/${{ matrix.container.name }}:latest

          # Test container can start (if it has an entrypoint/cmd)
          if docker run --rm --entrypoint="" test/${{ matrix.container.name }}:latest sh -c "exit 0" 2>/dev/null; then
            echo "✓ Container starts successfully"
          else
            echo "ℹ Container requires specific entrypoint (this is normal for some containers)"
          fi

  python-tests:
    name: Python Script Testing
    needs: prepare
    if: github.event_name == 'workflow_dispatch' || needs.prepare.outputs.changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup environment
        uses: ./.github/actions/setup

      - name: Install test dependencies
        run: |
          poetry add --group dev pytest pytest-cov pytest-mock

      - name: Run Python script tests
        run: |
          # Run existing tests
          if [ -f "test_ai_cli.py" ]; then
            poetry run pytest test_ai_cli.py -v
          fi

          # Test script imports and basic functionality
          poetry run python -c "
          import sys
          sys.path.append('scripts')

          # Test core scripts can be imported
          modules = [
              'generate_dockerfile',
              'collect_docker_metrics',
              'generate_image_tags',
              'build_multiarch',
              'template_engine'
          ]

          for module in modules:
              try:
                  __import__(module)
                  print(f'✓ {module} imports successfully')
              except Exception as e:
                  print(f'✗ {module} failed to import: {e}')
                  sys.exit(1)
          "

      - name: Test Poetry script entry points
        run: |
          # Test that all Poetry scripts are callable
          poetry run generate-dockerfile --help
          poetry run collect-docker-metrics --help
          poetry run generate-image-tags --help

      - name: Validate script configurations
        run: |
          # Validate pyproject.toml
          poetry check

  linting:
    name: Code Quality & Linting
    needs: prepare
    if: github.event_name == 'workflow_dispatch' || needs.prepare.outputs.changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup environment
        uses: ./.github/actions/setup

      - name: Setup Node.js for Dockerfile linting
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install Node.js dependencies
        run: pnpm install

      - name: Run Hadolint (Dockerfile linting)
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
        with:
          dockerfile: './node/*/Dockerfile'
          recursive: true
          format: sarif
          output-file: hadolint.sarif
          no-fail: true

      - name: Upload Hadolint SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@0499de31b99561a6d14a36a5f662c2a54f91beee # v4.31.2
        with:
          sarif_file: hadolint.sarif

      - name: Run yamllint
        run: |
          poetry add --group dev yamllint
          yamllint -c .yamllint.yaml . --format github

      - name: Run Python linting with Black
        run: |
          poetry add --group dev black
          poetry run black --check --diff scripts/*.py

      - name: Run Python static analysis
        run: |
          poetry add --group dev pylint
          # Run pylint on scripts directory with some common warnings disabled for now
          poetry run pylint scripts/ --disable=C0114,C0115,C0116,R0903,W0613 --reports=n || true

      - name: Check Python import sorting
        run: |
          poetry add --group dev isort
          poetry run isort --check-only --diff scripts/*.py

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: detect-containers
    if: needs.detect-containers.outputs.has-containers == 'true'
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJSON(needs.detect-containers.outputs.containers) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@18ce135bb5112fa8ce4ed6c17ab05699d7f3a5e0 # v3.11.0

      - name: Build image for security scan
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ${{ matrix.container.path }}
          file: ${{ matrix.container.path }}/Dockerfile
          platforms: linux/amd64
          push: false
          tags: scan/${{ matrix.container.name }}:latest
          load: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          image-ref: scan/${{ matrix.container.name }}:latest
          format: sarif
          output: trivy-${{ matrix.container.name }}.sarif

      - name: Upload Trivy SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@0499de31b99561a6d14a36a5f662c2a54f91beee # v4.31.2
        with:
          sarif_file: trivy-${{ matrix.container.name }}.sarif

      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: config
          scan-ref: ${{ matrix.container.path }}
          format: sarif
          output: trivy-config-${{ matrix.container.name }}.sarif

      - name: Upload Trivy config SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@0499de31b99561a6d14a36a5f662c2a54f91beee # v4.31.2
        with:
          category: config
          sarif_file: trivy-config-${{ matrix.container.name }}.sarif
