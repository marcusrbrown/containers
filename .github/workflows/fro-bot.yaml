---
name: Fro Bot

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  discussion_comment:
    types: [created]
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      prompt:
        description: Custom prompt for the Fro Bot agent
        required: true

permissions:
  contents: read

concurrency:
  group: >-
    fro-bot-${{
      github.event.issue.number ||
      github.event.pull_request.number ||
      github.event.discussion.number ||
      github.run_id
    }}
  cancel-in-progress: false

env:
  PR_REVIEW_PROMPT: |
    Review this container/automation PR focusing on:
    - Dockerfile best practices: pinned base images, minimal layers, non-root users, cache cleanup
    - Multi-architecture correctness ($TARGETPLATFORM / $TARGETARCH usage)
    - Python script quality: type hints, error handling, subprocess safety
    - GitHub Actions security: SHA-pinned actions, minimal permissions, no secret leaks
    - Breaking changes to container images or Poetry script entry points
    Skip style nits — Black, isort, Prettier, and pre-commit handle formatting.

  SCHEDULE_PROMPT: |
    Perform daily repository autohealing. Work through each category in order,
    making commits and pushing fixes directly where possible.

    1. ERRORED PRs: Find open PRs with failing CI checks. Check out each PR branch,
       diagnose the failure from the check logs, fix the issue, and push the fix.
       Comment on the PR explaining what was fixed.

    2. SECURITY: Review Dependabot/Renovate alerts and open PRs for vulnerable deps.
       If a security update PR exists but has conflicts or failures, fix and push.
       For unaddressed critical/high advisories, create a PR with the fix.

    3. HEALTH & MAINTENANCE: Check for outdated major versions of dependencies in
       pyproject.toml, package.json, and GitHub Actions workflow files. Create PRs
       to migrate to current major versions (one PR per major bump). Pin any
       unpinned GitHub Actions with SHA256 hashes.

    4. DEVELOPER EXPERIENCE: Ensure consistent linting, formatting, and static
       analysis across the repo. Run `pre-commit run --all-files` and fix any
       failures. Verify Black, isort, Prettier, yamllint, and dockerfilelint
       configs are consistent and applied. Fix any drift.

    After completing all work, create a SINGLE issue titled
    "Daily Autohealing Report — YYYY-MM-DD" summarizing actions taken,
    PRs created/fixed, and any items that need human attention.
    Do NOT comment on individual issues. Produce one summary issue only.

jobs:
  fro-bot:
    name: Fro Bot
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      discussions: write
      issues: write
      pull-requests: write
    if: >-
      (
        github.event.pull_request == null ||
        !github.event.pull_request.head.repo.fork
      ) && (
        (
          github.event_name == 'issues' &&
          !endsWith(github.event.issue.user.login || '', '[bot]')
        ) ||
        github.event_name == 'schedule' ||
        github.event_name == 'workflow_dispatch' ||
        github.event_name == 'pull_request' ||
        (
          (github.event_name == 'issue_comment' ||
           github.event_name == 'pull_request_review_comment' ||
           github.event_name == 'discussion_comment') &&
          contains(github.event.comment.body || '', '@fro-bot') &&
          (github.event.comment.user.login || '') != 'fro-bot' &&
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || '')
        )
      )
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: >-
            ${{
              (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number))
              || github.event.pull_request.head.sha
              || ''
            }}
          token: >-
            ${{
              github.event_name == 'workflow_dispatch'
              && secrets.GITHUB_TOKEN
              || secrets.FRO_BOT_PAT
            }}

      - name: Setup environment
        uses: ./.github/actions/setup

      - name: Install Node.js dependencies
        run: pnpm install

      - name: Run Fro Bot
        uses: fro-bot/agent@ace26b770cc0efd5c65c3b8e091c2f7e167ae372 # v0.26.16
        env:
          OPENCODE_PROMPT_ARTIFACT: 'true'
          PROMPT: >-
            ${{
              (github.event_name == 'workflow_dispatch' && (github.event.inputs.prompt || ''))
              || (github.event_name == 'schedule' && env.SCHEDULE_PROMPT)
              || (github.event_name == 'pull_request' && env.PR_REVIEW_PROMPT)
              || ''
            }}
        with:
          github-token: >-
            ${{
              github.event_name == 'workflow_dispatch'
              && secrets.GITHUB_TOKEN
              || secrets.FRO_BOT_PAT
            }}
          auth-json: ${{ secrets.OPENCODE_AUTH_JSON }}
          prompt: ${{ env.PROMPT }}
